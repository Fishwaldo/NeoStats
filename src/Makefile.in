# Makefile for NeoStats
include Makefile.inc 

NEOCFLAGS = $(CFLAGS)
EXTRA_LDFLAGS = `curl/mycurl-config --libs`

PCRE_OBJS = pcre/pcre.o pcre/get.o pcre/study.o
ADNS_OBJS =	adns/check.o adns/event.o adns/general.o adns/parse.o adns/query.o \
		adns/reply.o adns/setup.o adns/transmit.o adns/types.o
KEEPER_OBJS = keeper/kp_cache.o keeper/kp_dir.o keeper/kp_enum.o keeper/kp_get.o \
		keeper/kp_iface.o keeper/kp_recur.o keeper/kp_set.o keeper/kp_sort.o \
		keeper/kp_util.o
@IRCD_FILES_OBJS@: @IRCD_FILES_SRC@
OBJS = ${SRCS:.c=.o} @IRCD_FILES_OBJS@
SRCS =	dns.c chans.c dotconf.c services.c main.c sock.c conf.c ircd.c timer.c \
		users.c ns_help.c dl.c list.c hash.c server.c keeper.c log.c misc.c \
		support.c ircstring.c commands.c transfer.c exclude.c match.c bans.c 
		IRCDSRC = protocol/ultimate.c protocol/unreal.c protocol/hybrid7.c protocol/neoircd.c \
		protocol/bahamut.c protocol/ircu.c protocol/mystic.c protocol/quantum.c \
		protocol/liquid.c protocol/viagra.c
IRCDINC = ${IRCDSRC:.c=.h}

INCLUDES = config.h dl.h dotconf.h hash.h list.h stats.h neostats.h \
		conf.h log.h support.h ircstring.h events.h numeric.h pcre.h \
		transfer.h
COREINCS = dns.h services.h sock.h ircd.h exclude.h \
		ns_help.h timer.h users.h chans.h server.h bans.h
BUILDFILES = *.in modules/Makefile modules/Makefile.inc.in

DISTFILES = $(INCLUDES) $(COREINCS) $(SRCS) $(IRCDSRC) $(IRCDINC) \
		$(BUILDFILES) 
 
DISTLIBS = adns pcre curl sqlsrv keeper
DISTMOD = connectserv extauth hostserv loveserv moraleserv statserv template

all: @buildsqlsrv@ libadns libkeeper libpcre libcurl.a neostats modules utils 

modules:
	(cd modules; $(MAKE) $@)

libadns:
	(cd adns; $(MAKE))

libkeeper:
	(cd keeper; $(MAKE))

libpcre:
	(cd pcre; $(MAKE))

libcurl.a:
	(cd curl; $(MAKE))

sqlsrvlib:
	(cd sqlsrv; $(MAKE))

utils:
	(cd tools; $(MAKE) $@)

buildversion: 
	@(if test -f version.sh ; then $(SHELL) version.sh; else echo > version.h; fi)

neostats: buildversion $(OBJS)
	$(CC) $(LDFLAGS) $(OBJS) @sqlsrvbuild@ $(ADNS_OBJS) $(KEEPER_OBJS) $(PCRE_OBJS) curl/libcurl.a @LIBDB@ $(EXTRA_LDFLAGS) -o $@

# include dependency info 
@MAKEDEPENDENCIES@

.c.o:
	$(CC) $(NEOCFLAGS) $(NEOINCLUDES) -c $< 
	$(CC) -MM $(NEOINCLUDES) -c $< > $*.d

clean:
	(cd modules; $(MAKE) $@)
	(cd adns; $(MAKE) $@)
	(cd keeper; $(MAKE) $@)
	(cd tools; $(MAKE) $@)
	(cd pcre; $(MAKE) $@)
	(cd curl; $(MAKE) $@)
	(cd sqlsrv; $(MAKE) $@)
	$(RM) *.o neostats *.cache Makefile config.h Makefile.inc modules/Makefile.inc *.log *.a *.d *.exe version.h

distclean:
	(cd modules; $(MAKE) $@)
	(cd adns; $(MAKE) $@)
	(cd keeper; $(MAKE) $@)
	(cd tools; $(MAKE) $@)
	(cd pcre; $(MAKE) $@)
	(cd curl; $(MAKE) $@)
	(cd sqlsrv; $(MAKE) $@)
	$(RM) *.o neostats *.cache Makefile config.h Makefile.inc modules/Makefile.inc *.log *.a *.d *.exe config.status version.h

install: neostats
	$(INSTALL_DATA) $(INCLUDES) @prefix@/include
	$(INSTALL_DATA) version.h @prefix@/include
	$(INSTALL_DATA) @IRCD_FILES_INC@ @prefix@/include
	(cd adns; $(MAKE) $@)
	(cd sqlsrv; $(MAKE) $@)
	(cd modules; $(MAKE) $@)
	(cd tools; $(MAKE) $@)

dist: 	
	@for file in $(DISTFILES); do \
		echo -n "."; \
		cp -pr $$file ../$(DISTDIR)/src/$$file; \
	done
	@echo "Done"
	@echo "Copying Library Distribution files"
	@for subdir in $(DISTLIBS); do \
		mkdir ../$(DISTDIR)/src/$$subdir; \
		chmod 777 ../$(DISTDIR)/src/$$subdir; \
		(cd $$subdir && $(MAKE) dist DISTDIR=../../$(DISTDIR)/src/$$subdir && cd ..) || exit 1; \
	done
	@echo "Done"
	@echo "Copying Tools Distribution files"
	@(cd tools && $(MAKE) dist DISTDIR=../../$(DISTDIR)/src/tools && cd ..) || exit 1;
	@echo "Done"
	@echo "Copying Module Distribution files"
	@for mod in $(DISTMOD); do \
		mkdir ../$(DISTDIR)/src/modules/$$mod; \
		(cd modules/$$mod && $(MAKE) dist DISTDIR=../../../$(DISTDIR)/src/modules/$$mod && cd ../..) || exit 1; \
	done
	@echo "Done"

# Catch any changes in compilation options at the top of this file
$(OBJS): Makefile Makefile.inc
