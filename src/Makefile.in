# Makefile for NeoStats
include Makefile.inc 

NEOCFLAGS = $(CFLAGS)
EXTRA_LDFLAGS = `curl/mycurl-config --libs`

PCRE_OBJS = pcre/pcre.o pcre/get.o pcre/study.o
ADNS_OBJS =	adns/check.o adns/event.o adns/general.o adns/parse.o \
		adns/query.o adns/reply.o adns/setup.o adns/transmit.o adns/types.o
KEEPER_OBJS = keeper/kp_cache.o keeper/kp_dir.o keeper/kp_enum.o \
		keeper/kp_get.o keeper/kp_iface.o keeper/kp_recur.o keeper/kp_set.o \
		keeper/kp_sort.o keeper/kp_util.o
PROTOCOL_OBJS = protocol/@PROTOCOL@.o
OBJS = ${SRCS:.c=.o} 
SRCS =	dns.c channels.c dotconf.c services.c main.c sock.c conf.c ircd.c \
		timer.c users.c ns_help.c dl.c list.c hash.c servers.c keeper.c log.c \
		misc.c support.c ircstring.c commands.c transfer.c exclude.c match.c \
		bans.c bots.c modules.c auth.c signals.c

INCLUDES = config.h neostats.h hash.h list.h numeric.h events.h pcre/pcre.h \
		support.h ircstring.h 
		
COREINCS = dns.h services.h sock.h ircd.h exclude.h ns_help.h timer.h \
		users.h channels.h servers.h bans.h bots.h modules.h commands.h \
		auth.h signals.h conf.h dotconf.h dl.h log.h transfer.h
BUILDFILES = *.in modules/Makefile modules/Makefile.inc.in

DISTFILES = $(INCLUDES) $(COREINCS) $(SRCS) $(BUILDFILES) 
 
DISTLIBS = neoprotocol libs sqlsrv
DISTMOD = connectserv hostserv loveserv moraleserv statserv template \
		  templateauth extauth ircdauth

all: buildversion @buildsqlsrv@ libs neoprotocol neostats neomodules utils 

sqlsrvlib:
	(cd sqlsrv; $(MAKE))

libs:
	(cd adns; $(MAKE))
	(cd keeper; $(MAKE))
	(cd pcre; $(MAKE))
	(cd curl; $(MAKE))

neoprotocol:
	(cd protocol; $(MAKE))

neomodules:
	(cd modules; $(MAKE))

utils:
	(cd tools; $(MAKE))

buildversion: 
	@(if test -f version.sh ; then $(SHELL) version.sh; else echo > version.h; fi)

neostats: $(OBJS) $(PROTOCOL_OBJS)
	$(CC) $(LDFLAGS) $(OBJS) $(PROTOCOL_OBJS) @sqlsrvbuild@ $(ADNS_OBJS) $(KEEPER_OBJS) $(PCRE_OBJS) curl/libcurl.a @LIBDB@ $(EXTRA_LDFLAGS) -o $@

# include dependency info 
@MAKEDEPENDENCIES@

.c.o:
	$(CC) $(NEOCFLAGS) $(NEOINCLUDES) -c $< 
	$(CC) -MM $(NEOINCLUDES) -c $< > $*.d

clean:
	(cd modules; $(MAKE) $@)
	(cd adns; $(MAKE) $@)
	(cd keeper; $(MAKE) $@)
	(cd tools; $(MAKE) $@)
	(cd pcre; $(MAKE) $@)
	(cd curl; $(MAKE) $@)
	(cd sqlsrv; $(MAKE) $@)
	$(RM) neostats *.o *.a *.d *.exe
	$(RM) Makefile Makefile.inc modules/Makefile.inc 
	$(RM) version.h config.h
	
distclean:
	(cd modules; $(MAKE) $@)
	(cd adns; $(MAKE) $@)
	(cd keeper; $(MAKE) $@)
	(cd tools; $(MAKE) $@)
	(cd pcre; $(MAKE) $@)
	(cd curl; $(MAKE) $@)
	(cd sqlsrv; $(MAKE) $@)
	$(RM) neostats *.o *.a *.d *.exe
	$(RM) Makefile Makefile.inc modules/Makefile.inc 
	$(RM) version.h config.h

install: neostats
	$(INSTALL_DATA) $(INCLUDES) @prefix@/include
	$(INSTALL_DATA) version.h @prefix@/include
	(cd adns; $(MAKE) $@)
	(cd sqlsrv; $(MAKE) $@)
	(cd modules; $(MAKE) $@)
	(cd tools; $(MAKE) $@)

dist: 	
	@for file in $(DISTFILES); do \
		echo -n "."; \
		cp -pr $$file ../$(DISTDIR)/src/$$file; \
	done
	@echo "Done"
	@echo "Copying Library Distribution files"
	@for subdir in $(DISTLIBS); do \
		mkdir ../$(DISTDIR)/src/$$subdir; \
		chmod 777 ../$(DISTDIR)/src/$$subdir; \
		(cd $$subdir && $(MAKE) dist DISTDIR=../../$(DISTDIR)/src/$$subdir && cd ..) || exit 1; \
	done
	@echo "Done"
	@echo "Copying Tools Distribution files"
	@(cd tools && $(MAKE) dist DISTDIR=../../$(DISTDIR)/src/tools && cd ..) || exit 1;
	@echo "Done"
	@echo "Copying Module Distribution files"
	@for mod in $(DISTMOD); do \
		mkdir ../$(DISTDIR)/src/modules/$$mod; \
		(cd modules/$$mod && $(MAKE) dist DISTDIR=../../../$(DISTDIR)/src/modules/$$mod && cd ../..) || exit 1; \
	done
	@echo "Done"

# Catch any changes in compilation options at the top of this file
$(OBJS): Makefile Makefile.inc
